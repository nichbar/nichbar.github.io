<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Kotlin Standard Functions · Nich's Blog</title><meta name="description" content="Kotlin Standard Functions - Nich"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="theme-color" content="#4fc08d"><link rel="short icon" href="/favicon.ico"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" type="text/css"><script>var host = "nich.work";
if ((host == window.location.host) && (window.location.protocol != "https:"))
   window.location.protocol = "https";</script></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/logo.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://www.github.com/nichbar" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">Kotlin Standard Functions</h1><div class="post-info">Jul 22, 2018</div><div class="post-content"><p>Kotlin 提供了一些 Extensions 叫 <a href="https://github.com/JetBrains/kotlin/blob/master/libraries/stdlib/src/kotlin/util/Standard.kt" target="_blank" rel="noopener">Standard Functions</a>，合理使用 Standard Functions 可以提高代码可读性。</p>
<p>本文主要分析学习下其中的  <code>T.run</code>, <code>T.apply</code>, <code>T.let</code>, <code>T.also</code>, <code>T.takeIf</code> 和 <code>T.takeUnless</code> 。</p>
<a id="more"></a>
<h3 id="T-run-amp-T-apply"><a href="#T-run-amp-T-apply" class="headerlink" title="T.run &amp; T.apply"></a>T.run &amp; T.apply</h3><p>直接看 <code>T.run</code>的源码</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T, R&gt;</span> T.<span class="title">run</span><span class="params">(block: <span class="type">T</span>.()</span></span> -&gt; R): R &#123;</span><br><span class="line">    <span class="keyword">return</span> block()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>很简短的一个 <a href="https://kotlinlang.org/docs/reference/inline-functions.html" target="_blank" rel="noopener">inline</a> 方法，其中的入参的 <code>T.() -&gt; R</code> 是这个方法的关键，在 Kotlin 里这种用法叫 <a href="https://kotlinlang.org/docs/reference/lambdas.html#function-literals-with-receiver" target="_blank" rel="noopener">Function literals with receiver</a> ，通过它 lambda 就可以直接获得一个显式的 <code>this</code> 指向 T 这个对象，所以在 <code>block()</code> 这个 lambda 里的上下文就变成了 T 。</p>
<p>这样通过 <code>T.run</code> 就能简洁地创建一个局部的上下文运行环境了。</p>
<p><code>T.apply</code> 与 <code>T.run</code> 唯一的不同在于 <code>T.apply</code> 执行完 lambda 后会返回 T ，而 <code>T.run</code> 返回的是 lambda 的执行结果<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> T.<span class="title">apply</span><span class="params">(block: <span class="type">T</span>.()</span></span> -&gt; <span class="built_in">Unit</span>): T &#123;</span><br><span class="line">    block()</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>下面用两个例子来简单说明 <code>T.run</code> 和 <code>T.apply</code> 的用法</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用 T.run 前</span></span><br><span class="line">mBinding?.gameList?.(<span class="keyword">this</span>.itemAnimator <span class="keyword">as</span> DefaultItemAnimator).supportsChangeAnimations = <span class="literal">false</span></span><br><span class="line">mBinding?.gameList?.layoutManager = mLayoutManager</span><br><span class="line">mBinding?.gameList?.adapter = mListAdapter</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 T.run 后</span></span><br><span class="line">mBinding?.gameList?.run &#123;</span><br><span class="line">    (itemAnimator <span class="keyword">as</span> DefaultItemAnimator).supportsChangeAnimations = <span class="literal">false</span></span><br><span class="line">    layoutManager = mLayoutManager</span><br><span class="line">    adapter = mListAdapter</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 T.apply 前</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">getInstance</span><span class="params">(openingEntity: <span class="type">OpeningEntity</span>?)</span></span>: OpeningDialog &#123;</span><br><span class="line">    <span class="keyword">val</span> dialog = OpeningDialog()</span><br><span class="line">    dialog.mOpeningEntity = openingEntity</span><br><span class="line">    <span class="keyword">return</span> dialog</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 T.apply 后</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">getInstance</span><span class="params">(openingEntity: <span class="type">OpeningEntity</span>?)</span></span> = OpeningDialog().apply &#123;</span><br><span class="line">    mOpeningEntity = openingEntity</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="T-let-amp-T-also"><a href="#T-let-amp-T-also" class="headerlink" title="T.let &amp; T.also"></a>T.let &amp; T.also</h3><p><code>T.let</code> 与 <code>T.also</code> 的关系跟上述类似</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T, R&gt;</span> T.<span class="title">let</span><span class="params">(block: (<span class="type">T</span>)</span></span> -&gt; R): R &#123;</span><br><span class="line">    <span class="keyword">return</span> block(<span class="keyword">this</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> T.<span class="title">also</span><span class="params">(block: (<span class="type">T</span>)</span></span> -&gt; <span class="built_in">Unit</span>): T &#123;</span><br><span class="line">    block(<span class="keyword">this</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>T.let</code> 返回的是 lambda 的执行结果，<code>T.also</code> 返回的是 T 本身</p>
<p><code>T.let</code> 和 <code>T.also</code> 都使用了 T 做为 lambda 的入参，所以我们在使用时需要以 <code>it</code> 或重命名的 T 来调用 T 的方法。</p>
<p><code>T.let</code> 常用于创建局部运行环境，<code>T.also</code> 因为其返回 T 本身则可以用于构建链式调用。</p>
<h3 id="T-takeIf-amp-T-takeUnless"><a href="#T-takeIf-amp-T-takeUnless" class="headerlink" title="T.takeIf &amp; T.takeUnless"></a>T.takeIf &amp; T.takeUnless</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> T.<span class="title">takeIf</span><span class="params">(predicate: (<span class="type">T</span>)</span></span> -&gt; <span class="built_in">Boolean</span>): T? &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">if</span> (predicate(<span class="keyword">this</span>)) <span class="keyword">this</span> <span class="keyword">else</span> <span class="literal">null</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> T.<span class="title">takeUnless</span><span class="params">(predicate: (<span class="type">T</span>)</span></span> -&gt; <span class="built_in">Boolean</span>): T? &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">if</span> (!predicate(<span class="keyword">this</span>)) <span class="keyword">this</span> <span class="keyword">else</span> <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>很好理解，<code>T.takeIf</code> 是当传入的 lambda 返回 true 时返回 T，而 <code>T.takeUnless</code> 则是当传入的 lambda 返回 false 时返回 T。</p>
<p><code>T.takeUnless</code>  的简单用法</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">getInstance</span><span class="params">(welcomeEntity: <span class="type">WelcomeDialogEntity</span>?)</span></span> = welcomeEntity</span><br><span class="line">    .takeUnless &#123; it?.icon.isNullOrEmpty() &#125; <span class="comment">// 当 welcomeEntity 的 icon 为空时返回空</span></span><br><span class="line">    .let &#123; WelcomeDialog() &#125; <span class="comment">// 创建 WelcomeDialog</span></span><br><span class="line">    .apply &#123; mWelcomeEntity = welcomeEntity &#125; <span class="comment">// 赋值</span></span><br></pre></td></tr></table></figure>
<h3 id="尾声"><a href="#尾声" class="headerlink" title="尾声"></a>尾声</h3><p>你或许会好奇创建这么多 lambda 是否会影响性能，答案是不会，理由是上面描述的方法使用了 <a href="https://kotlinlang.org/docs/reference/inline-functions.html" target="_blank" rel="noopener">inline</a> 关键字。</p>
<h3 id="Refenece"><a href="#Refenece" class="headerlink" title="Refenece"></a>Refenece</h3><ul>
<li><a href="https://medium.com/@elye.project/mastering-kotlin-standard-functions-run-with-let-also-and-apply-9cd334b0ef84" target="_blank" rel="noopener">Mastering Kotlin standard functions: run, with, let, also and apply</a></li>
</ul>
</div></article></div></section><footer><div class="paginator"><a href="/2018/kotlin-extension/" class="prev">PREV</a><a href="/2018/use-gradle-plugin-to-generate-code/" class="next">NEXT</a></div><div class="copyright"><p>© 2016 - 2019 <a href="https://nich.work">Nich</a>, blow through the ceiling.</p></div></footer></div><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-103473739-1",'auto');ga('send','pageview');</script></body></html>